var selector1,friendIds=[],loggedIn=!1,friendNames={},currentUserName,currentUserId,theScope="user_status,user_likes,user_actions.videos,user_actions.music,friends_likes,friends_status,friends_actions.music,friends_actions.video";
function addUI(){$("#modal_body").html("<div id='fb_friend_select'></div><input type='button' value='Login To Facebook' onclick='loginFB()' id='fb_login'  class='btn btn-primary' style='margin-right : 5px'><input type='button' value='Add Facebook Friends' onclick='selectFriends()'  class='btn btn-primary'><br><br><br><div id='friend_display_area'></div>")}
function worksUI(){$("#modal-content").html("<h3>Permissions</h3><br> <ol><li>Your status updates</li><li>Your friends status updates</li><li>Your likes</li><li>Your friends likes</li><li>Music you like</li><li>Music your friends like</li><li>Videos you like</li><li>Videos your friends like</li></ol><p>NB : Without granting the application the required permissions it will not work</p><h3>Privacy</h3><br><p>We <b>never</b> share your data with anyone</p><h3>How it works</h3><br><p>This application compares you with the <b>Facebook</b> friends you select below and tells you who among them is most like you based on your <b>likes</b>, <b>status updates</b> and <b>other data</b> on facebook. Click on add facebook friends and select upto a maximum of <b>ten friends</b> to compare.</p><h3>Feedback</h3><p> For feedback or just to say hi you can reach the developer here <a href='http://www.facebook.com/constant.oduol'>Here</a> or <a href='mailto:oduolconstant@gmail.com'>Here</a></p>")}
function onLoad(){ui.staticmodal("content","Compare to see who of your friends is most like you on facebook<span id='load_area' style='float: right; display : none;'><img src='img/ajax-loader.gif'></span>","addUI()")}function showAbout(){ui.modal("About","worksUI()","dismissModal()","")}function dismissModal(){$("#alert-window").modal("hide")}window.onload=function(){onLoad();initFB();window.onresize=ui.resize};
function initFB(){FB.init({appId:"137400156430331",status:!0,cookie:!1,xfbml:!1,oauth:!0});FB.XFBML.parse();ensureFBLogin()}
function ensureFBLogin(){FB.getLoginStatus(function(b){b.authResponse?($("#fb_login").val("Already Logged In"),$("#fb_login").attr("disabled","true"),loggedIn=!0,FB.api("/me",function(a){currentUserName=a.name;currentUserId=a.id}),TDFriendSelector.init(),selector1=TDFriendSelector.newInstance({callbackSubmit:callbackSubmit,friendsPerPage:5,maxSelection:10,autoDeselection:!0})):loggedIn=!1})}
function loginFB(){FB.login(function(b){b.authResponse?($("#fb_login").val("Already Logged In"),$("#fb_login").attr("disabled","true"),loggedIn=!0,FB.api("/me",function(a){currentUserName=a.name;currentUserId=a.id}),TDFriendSelector.init(),selector1=TDFriendSelector.newInstance({callbackSubmit:callbackSubmit,friendsPerPage:5,maxSelection:5,autoDeselection:!0})):loggedIn=!1},{scope:theScope})}function logoutFB(){FB.logout(function(b){loggedIn=b.authResponse?!1:!0})}
function selectFriends(){loggedIn||loginFB();selector1&&(selector1.reset(),selector1.showFriendSelector())}callbackSubmit=function(b){friendIds=b;friendNames={};renderFriendProfiles()};
function renderFriendProfiles(){var b=$("<table class='table table-condensed' style='font-size: 16px;' id='friend_result_area'>"),a=$("<th style='width : 100px'>"),e=$("<th>"),c=$("<th>"),d=$("<th>");a.html("Photo");e.html("Name");c.html("Compatibility Score(%)");d.html("Favorite Word");b.append(a).append(e).append(c).append(d);for(var f=0,a=0;a<friendIds.length;a++)FB.api({method:"fql.query",query:"SELECT name, pic_square,uid FROM user WHERE uid="+friendIds[a]},function(a){a[0]&&(friendNames[a[0].uid]=
a[0].name,b.append("<tr><td><img src="+a[0].pic_square+"></td><td><a href='https://www.facebook.com/"+a[0].uid+"' target='_blank' style='text-decoration: none;color: #000;'>"+a[0].name+"</a></td><td id='"+a[0].uid+"_percent'></td><td id='"+a[0].uid+"_fav_word'></td></tr><br>"),$("#friend_display_area").html(b));f++});var g=setInterval(function(){f===friendIds.length&&(clearInterval(g),sendToServer())},5);b.append("<tr><td></td><td></td><td><a href='#' onclick='shareResults()'>Share results to timeline</a></td><td></td></tr>")}
function sendToServer(){$("#load_area").css("display","block");-1===friendIds.indexOf("me")&&friendIds.push("me");if(1!==friendIds.length){var b={request_header:{request_msg:"access_token"},request_object:{access_token:FB.getAccessToken(),friend_ids:friendIds,friend_names:friendNames,current_user_name:currentUserName,current_user_id:currentUserId}};ajax.run({url:"/fb",type:"post",data:b,error:function(a){ui.modal("Error","modalData('Whoops an error occurred!')","dismissModal()","");$("#load_area").css("display",
"none")},success:function(a){for(var b in a.data.percentages){var c=a.data.percentages[b].total,d="black",d=60<c?"lightgreen":30<c?"orange":"#FF8F00",f=$("<table class='table table-bordered' style='width : auto ;font-size: 14px;'>"),g=$("<tr></tr>"),h=$("<td style='border-right-color : #51CBEE; width : 50px;'>Music</td>"),k=$("<td style='border-color : #51CBEE; background : #51CBEE; width : 30px;'>"+Math.round(a.data.percentages[b].music)+"</td>"),l=$("<td style='border-right-color : #51CBEE; width : 50px;'>Statuses</td>"),
m=$("<td style='border-color : #51CBEE; background : #51CBEE;width : 30px;'>"+Math.round(a.data.percentages[b].statuses)+"</td>"),n=$("<td style='border-right-color : #51CBEE; width : 50px;'>Likes</td>"),p=$("<td style='border-color : #51CBEE; background : #51CBEE;width : 30px;'>"+Math.round(a.data.percentages[b].likes)+"</td>"),q=$("<td style='border-right-color : #51CBEE; width : 50px;'>Movies</td>"),r=$("<td style='border-color : #51CBEE; background : #51CBEE;width : 30px;'>"+Math.round(a.data.percentages[b].movies)+
"</td>"),s=$("<td style='border-right-color : #51CBEE; width : 50px;'>Books</td>"),t=$("<td style='border-color : #51CBEE; background : #51CBEE;width : 30px;'>"+Math.round(a.data.percentages[b].books)+"</td>"),c=$("<td style='background : "+d+"; border-color : "+d+" ; width : 30px;'>"+Math.round(c)+"</td>");g.append(h).append(k).append(l).append(m).append(n).append(p).append(q);g.append(r).append(s).append(t).append(c);f.append(g);$("#"+b+"_percent").append(f);$("#"+b+"_fav_word").html("<b>"+a.data.fav_words[b]+
"</b>")}$("#load_area").css("display","none")}})}}function modalData(b){$("#modal-content").html(b)}function dismissModal(){$("#alert-window").modal("hide")}
function shareResults(){var b="How i match up against my friends ";theScope+=",publish_actions";FB.login(function(a){if(a.authResponse){for(a=1;a<friendIds.length;a++){var e=dom.el("friend_result_area").children[4].children[a].children[1].firstChild.innerHTML,c=dom.el("friend_result_area").children[4].children[a].children[2].firstChild.firstChild.firstChild.children[10].innerHTML;b=a===friendIds.length-1?b+e+" : "+c+"% ":b+e+" : "+c+"%, "}shareToTimeline(b)}},{scope:theScope})}
function shareToTimeline(b){FB.ui({method:"feed",name:"CompatibilityMatcher",link:"https://am-compatible.appspot.com/",picture:"https://am-compatible.appspot.com/img/compatible.png",description:b},function(a){a&&a.post_id?(ui.modal("Success","modalData('Post was published to timeline successfully')","dismissModal()",""),noteShareToServer()):ui.modal("Error","modalData('Whoops an error occurred! post was not shared to timeline')","dismissModal()","")})}
function noteShareToServer(){ajax.run({url:"/fb",type:"post",data:{request_header:{request_msg:"share_post"},request_object:{current_user_name:currentUserName,current_user_id:currentUserId}},error:function(b){},success:function(b){}})};